<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>å®æ—¶å¯¹è¯ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }

        .video-page-container {
            display: flex;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .video-display {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .video-display video {
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .form-section {
            flex: 1;
            padding: 20px;
            background: #f9f9f9;
            border-left: 1px solid #eee;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        select, input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .generate-btn {
            width: 100%;
            padding: 12px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .generate-btn:hover {
            background-color: #2980b9;
        }

        .voice-recorder {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .recorder-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .record-btn {
            padding: 15px 30px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 0 auto 15px;
            min-width: 200px;
        }

        .record-btn:hover {
            background-color: #c0392b;
            transform: scale(1.05);
        }

        .record-btn.recording {
            background-color: #27ae60;
            animation: pulse 1.5s infinite;
        }

        .record-btn.recording:hover {
            background-color: #229954;
        }

        .upload-btn {
            padding: 12px 24px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }

        .upload-btn:hover {
            background-color: #2980b9;
            transform: scale(1.05);
        }

        .divider {
            margin: 20px 0;
            display: flex;
            align-items: center;
            text-align: center;
            color: #999;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #ddd;
        }

        .divider span {
            padding: 0 10px;
            font-size: 14px;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(46, 204, 113, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(46, 204, 113, 0);
            }
        }

        .timer {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin: 15px 0;
        }

        .recording-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            background-color: #e74c3c;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 50% {
                opacity: 1;
            }
            51%, 100% {
                opacity: 0;
            }
        }

        .status-message {
            margin-top: 10px;
            font-size: 14px;
            color: #7f8c8d;
        }
    </style>
</head>

<body class="subpage-bg">
    <h2>å®æ—¶å¯¹è¯ç³»ç»Ÿ</h2>
    <div class="video-page-container">
        <div class="video-display">
            <!-- è¯­éŸ³å½•åˆ¶å™¨ -->
            <div class="voice-recorder">
                <h3 style="margin-bottom: 20px; color: #2c3e50;">ğŸ“¢ å¼€å§‹å¯¹è¯</h3>
                
                <!-- å½•éŸ³æŒ‰é’® -->
                <button id="recordButton" class="record-btn">
                    <span>ğŸ™ï¸</span> ç‚¹å‡»å¼€å§‹å½•éŸ³
                </button>
                <div class="timer" id="timer">00:00</div>
                <div class="recording-indicator" id="recordingIndicator" style="display: none;">
                    <div class="recording-dot"></div>
                    <span>æ­£åœ¨å½•éŸ³...</span>
                </div>
                <div class="status-message" id="statusMessage">ç‚¹å‡»æŒ‰é’®å¼€å§‹å½•éŸ³ï¼Œå†æ¬¡ç‚¹å‡»ç»“æŸå¹¶è‡ªåŠ¨å¤„ç†</div>
                
                <!-- åˆ†éš”çº¿ -->
                <div class="divider">
                    <span>æˆ–</span>
                </div>
                
                <!-- æ–‡ä»¶ä¸Šä¼  -->
                <input type="file" id="uploadAudioFile" accept="audio/*" style="display: none;">
                <button id="uploadButton" class="upload-btn">
                    <span>ğŸ“</span> ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶
                </button>
                <div style="margin-top: 10px; font-size: 12px; color: #888;">
                    æ”¯æŒ mp3ã€wavã€m4a ç­‰æ ¼å¼
                </div>
            </div>
            <!-- å·¦ä¾§è§†é¢‘æ˜¾ç¤º -->
            <video id="chatVideo" controls width="420">
                <source src="{{ url_for('static', filename='videos/sample.mp4') }}" type="video/mp4">
            </video>
            <audio id="ttsAudio" controls style="margin-top:10px; width: 100%;"></audio>
            <div id="textOutputs" style="margin-top:12px; width:100%;">
                <div style="margin:6px 0;"><strong>è¯†åˆ«æ–‡æœ¬ï¼š</strong><span id="recognizedText">ï¼ˆå¾…è¯†åˆ«ï¼‰</span></div>
                <div style="margin:6px 0;"><strong>AIå›å¤ï¼š</strong><span id="aiText">ï¼ˆå¾…ç”Ÿæˆï¼‰</span></div>
            </div>
        </div>

        <!-- å³ä¾§å‚æ•°åŒº -->
        <div class="form-section">
            <form id="chatForm">
                <div class="form-group">
                    <label>æ¨¡å‹åç§°</label>
                    <select name="model_name" id="chatModelName">
                        <option value="">ä¸ä½¿ç”¨æ•°å­—äººï¼ˆä»…è¯­éŸ³ï¼‰</option>
                        <option value="SyncTalk">SyncTalk</option>
                        <option value="GaussianTalker">GaussianTalker</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>æ¨¡å‹ç›®å½•åœ°å€</label>
                    <input type="text" name="model_param" placeholder="è¯·è¾“å…¥æ¨¡å‹ç›®å½•è·¯å¾„">
                </div>

                <div class="form-group">
                    <label>è¯­éŸ³å…‹éš†å‚è€ƒéŸ³é¢‘ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="file" name="ref_audio_file" id="ref_audio_file" accept="audio/*" style="margin-bottom: 10px;">
                    <input type="text" name="ref_audio" id="ref_audio_path" placeholder="æˆ–è¾“å…¥éŸ³é¢‘è·¯å¾„">
                    <small style="color: #666;">ä¸Šä¼ å‚è€ƒéŸ³é¢‘ä»¥å…‹éš†æ•°å­—äººçš„å£°éŸ³ï¼Œä¸ä¸Šä¼ åˆ™ä½¿ç”¨é»˜è®¤TTSéŸ³è‰²ï¼ˆæ”¯æŒæ‹–æ‹½ï¼‰</small>
                </div>

                <div class="form-group">
                    <label>GPUé€‰æ‹©</label>
                    <select name="gpu_choice" id="gpu_choice_select_chat">
                        <option value="GPU0">GPU 0</option>
                        <option value="GPU1">GPU 1</option>
                        <option value="CPU">CPU</option>
                        <option value="cloud">Cloud (AutoDL)</option>
                    </select>
                </div>

                <!-- äº‘ç«¯SSHé…ç½® -->
                <div id="cloud_config_group_chat" style="display: none;">
                    <div class="form-group">
                        <label>SSHç«¯å£å·</label>
                        <input type="number" name="ssh_port" value="40258">
                    </div>
                    <div class="form-group">
                        <label>SSHå¯†ç </label>
                        <input type="password" name="ssh_password" value="83WncIL5CoYB">
                    </div>
                </div>

                <div class="form-group" id="chatBatchSizeGroup" style="display:none;">
                    <label>Batch Sizeï¼ˆGaussianTalkerï¼‰</label>
                    <input type="number" name="batch_size" min="1" value="128">
                </div>

                <div class="form-group" id="chatIterationGroup" style="display:none;">
                    <label>Iterationï¼ˆGaussianTalkeræ£€æŸ¥ç‚¹ï¼‰</label>
                    <input type="number" name="iteration" min="1" value="10000">
                </div>

                <div class="form-group">
                    <label>å¯¹è¯APIé€‰æ‹©</label>
                    <select name="api_choice">
                        <option value="openai">OpenAI API</option>
                        <option value="azure">Azure Speech API</option>
                    </select>
                </div>

                <button type="submit" class="generate-btn" style="display:none;" id="manualStartBtn">âš™ï¸ æ‰‹åŠ¨è§¦å‘å¯¹è¯</button>
                <div style="padding: 12px; background: #e8f5e9; border-radius: 4px; font-size: 14px; color: #2e7d32; text-align: center;">
                    <strong>ğŸ’¡ æç¤ºï¼š</strong>å·¦ä¾§å½•éŸ³æˆ–ä¸Šä¼ éŸ³é¢‘åå°†è‡ªåŠ¨å¼€å§‹å¯¹è¯
                </div>
            </form>
        </div>
    </div>

    <script>
        // æ§åˆ¶GaussianTalkerå­—æ®µå’Œäº‘ç«¯é…ç½®çš„æ˜¾ç¤º/éšè—
        document.addEventListener('DOMContentLoaded', function() {
            const modelSelect = document.getElementById('chatModelName');
            const gpuChoiceSelectChat = document.getElementById('gpu_choice_select_chat');
            const batchSizeGroup = document.getElementById('chatBatchSizeGroup');
            const iterationGroup = document.getElementById('chatIterationGroup');
            const cloudConfigGroupChat = document.getElementById('cloud_config_group_chat');
            
            function toggleGaussianTalkerFields() {
                const selectedModel = modelSelect.value;
                if (selectedModel === 'GaussianTalker') {
                    batchSizeGroup.style.display = 'block';
                    iterationGroup.style.display = 'block';
                } else {
                    batchSizeGroup.style.display = 'none';
                    iterationGroup.style.display = 'none';
                }
            }
            
            function toggleCloudConfigChat() {
                const isCloud = gpuChoiceSelectChat.value === 'cloud';
                cloudConfigGroupChat.style.display = isCloud ? 'block' : 'none';
            }
            
            modelSelect.addEventListener('change', toggleGaussianTalkerFields);
            gpuChoiceSelectChat.addEventListener('change', toggleCloudConfigChat);
            toggleGaussianTalkerFields(); // åˆå§‹åŒ–
            toggleCloudConfigChat(); // åˆå§‹åŒ–

            // å‚è€ƒéŸ³é¢‘æ–‡ä»¶æ‹–æ‹½æ”¯æŒ
            const refAudioFile = document.getElementById('ref_audio_file');
            
            refAudioFile.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.border = '2px dashed #4CAF50';
            });
            
            refAudioFile.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.border = '';
            });
            
            refAudioFile.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.border = '';
                if (e.dataTransfer.files.length > 0) {
                    this.files = e.dataTransfer.files;
                }
            });
        });

        // è¯­éŸ³å½•åˆ¶åŠŸèƒ½
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let startTime;
        let timerInterval;
        
        const recordButton = document.getElementById('recordButton');
        const timerDisplay = document.getElementById('timer');
        const recordingIndicator = document.getElementById('recordingIndicator');
        const statusMessage = document.getElementById('statusMessage');
        
        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // æ›´æ–°è®¡æ—¶å™¨
        function updateTimer() {
            const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
            timerDisplay.textContent = formatTime(elapsedSeconds);
        }
        
        // å¼€å§‹å½•éŸ³
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    
                    // åˆ›å»ºFormDataå¹¶å‘é€åˆ°æœåŠ¡å™¨
                    const formData = new FormData();
                    formData.append('audio', audioBlob, 'input.wav');
                    
                    fetch('/save_audio', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            statusMessage.textContent = 'å½•éŸ³å·²ç»“æŸ';
                        } else {
                            statusMessage.textContent = 'ä¿å­˜å½•éŸ³å¤±è´¥';
                        }
                    })
                    .catch(error => {
                        console.error('ä¿å­˜å½•éŸ³é”™è¯¯:', error);
                        statusMessage.textContent = 'ä¿å­˜å½•éŸ³æ—¶å‡ºé”™';
                    });
                    
                    // åœæ­¢æ‰€æœ‰éŸ³é¢‘è½¨é“
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                recordButton.innerHTML = '<span>â¹ï¸</span> ç‚¹å‡»ç»“æŸå½•éŸ³';
                recordButton.classList.add('recording');
                recordingIndicator.style.display = 'flex';
                statusMessage.textContent = 'æ­£åœ¨å½•éŸ³ä¸­ï¼Œå†æ¬¡ç‚¹å‡»ç»“æŸ...';
                
                // å¯åŠ¨è®¡æ—¶å™¨
                startTime = Date.now();
                timerInterval = setInterval(updateTimer, 1000);
                
            } catch (error) {
                console.error('è·å–éº¦å…‹é£æƒé™å¤±è´¥:', error);
                statusMessage.textContent = 'æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®';
            }
        }
        
        // åœæ­¢å½•éŸ³
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                recordButton.innerHTML = '<span>ğŸ™ï¸</span> ç‚¹å‡»å¼€å§‹å½•éŸ³';
                recordButton.classList.remove('recording');
                recordingIndicator.style.display = 'none';
                statusMessage.textContent = 'å½•éŸ³å®Œæˆï¼Œæ­£åœ¨å¤„ç†...';
                
                // åœæ­¢è®¡æ—¶å™¨
                clearInterval(timerInterval);
                
                // ç­‰å¾…å½•éŸ³ä¿å­˜å®Œæˆåè‡ªåŠ¨è§¦å‘å¯¹è¯
                setTimeout(() => {
                    autoStartChat();
                }, 1000);
            }
        }
        
        // å½•éŸ³æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        recordButton.addEventListener('click', () => {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        });
        
        // ä¸Šä¼ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        const uploadButton = document.getElementById('uploadButton');
        const uploadAudioFileInput = document.getElementById('uploadAudioFile');
        
        uploadButton.addEventListener('click', () => {
            uploadAudioFileInput.click();
        });
        
        // æ–‡ä»¶é€‰æ‹©åè‡ªåŠ¨å¤„ç†
        uploadAudioFileInput.addEventListener('change', async function() {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                statusMessage.textContent = 'æ­£åœ¨ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶...';
                
                try {
                    // ä¸Šä¼ æ–‡ä»¶
                    const uploadFormData = new FormData();
                    uploadFormData.append('audio', file, 'input.wav');
                    
                    const response = await fetch('/save_audio', {
                        method: 'POST',
                        body: uploadFormData
                    });
                    
                    const data = await response.json();
                    if (data.status === 'success') {
                        statusMessage.textContent = 'éŸ³é¢‘ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨å¤„ç†...';
                        // è‡ªåŠ¨è§¦å‘å¯¹è¯
                        setTimeout(() => {
                            autoStartChat();
                        }, 500);
                    } else {
                        statusMessage.textContent = 'éŸ³é¢‘ä¸Šä¼ å¤±è´¥';
                        alert('ä¸Šä¼ å¤±è´¥: ' + data.message);
                    }
                } catch (error) {
                    console.error('ä¸Šä¼ é”™è¯¯:', error);
                    statusMessage.textContent = 'ä¸Šä¼ æ—¶å‡ºé”™';
                    alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
                }
            }
        });
        
        // è‡ªåŠ¨è§¦å‘å¯¹è¯å¤„ç†
        function autoStartChat() {
            const chatForm = document.getElementById('chatForm');
            const formData = new FormData(chatForm);
            
            statusMessage.textContent = 'æ­£åœ¨å¤„ç†å¯¹è¯...';
            
            processChat(formData);
        }

        // å¤„ç†å¯¹è¯çš„æ ¸å¿ƒå‡½æ•°
        async function processChat(formData) {
            const statusMessage = document.getElementById('statusMessage');

            // æ£€æŸ¥æ˜¯å¦ä¸Šä¼ äº†å‚è€ƒéŸ³é¢‘ï¼ˆè¯­éŸ³å…‹éš†ï¼‰
            const refAudioFileInput = document.getElementById('ref_audio_file');
            const refAudioFile = refAudioFileInput ? refAudioFileInput.files[0] : null;
            
            if (refAudioFile) {
                if (statusMessage) statusMessage.textContent = 'æ­£åœ¨ä¸Šä¼ å‚è€ƒéŸ³é¢‘...';
                
                try {
                    const uploadFormData = new FormData();
                    uploadFormData.append('file', refAudioFile);
                    uploadFormData.append('type', 'audio');
                    
                    const uploadRes = await fetch('/upload_file', {
                        method: 'POST',
                        body: uploadFormData
                    });
                    
                    const uploadData = await uploadRes.json();
                    if (uploadData.status === 'success') {
                        formData.set('ref_audio', uploadData.file_path);
                        console.log('å‚è€ƒéŸ³é¢‘ä¸Šä¼ æˆåŠŸ:', uploadData.file_path);
                    } else {
                        alert('å‚è€ƒéŸ³é¢‘ä¸Šä¼ å¤±è´¥: ' + uploadData.message);
                        return;
                    }
                } catch (err) {
                    alert('å‚è€ƒéŸ³é¢‘ä¸Šä¼ å¤±è´¥: ' + err.message);
                    return;
                }
            }

            if (statusMessage) statusMessage.textContent = 'æ­£åœ¨å¤„ç†å¯¹è¯...';
            
            fetch('/chat_system', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        // æ–‡æœ¬å±•ç¤º
                        const recEl = document.getElementById('recognizedText');
                        const aiEl = document.getElementById('aiText');
                        recEl.textContent = data.recognized_text || 'ï¼ˆæ— è¯†åˆ«æ–‡æœ¬ï¼‰';
                        aiEl.textContent = data.ai_text || 'ï¼ˆæ— AIå›å¤ï¼‰';

                        // æ’­æ”¾TTSï¼ˆå¦‚æœ‰ï¼‰
                        if (data.tts_audio_url) {
                            const ttsEl = document.getElementById('ttsAudio');
                            ttsEl.src = data.tts_audio_url + '?t=' + new Date().getTime();
                            ttsEl.load();
                            ttsEl.play().catch(() => {});
                        }

                        // åˆ·æ–°æ•°å­—äººè§†é¢‘
                        if (data.video_path) {
                            const videoEl = document.getElementById('chatVideo');
                            const newSrc = data.video_path + '?t=' + new Date().getTime();
                            videoEl.src = newSrc;
                            videoEl.load();
                        }

                        if (statusMessage) statusMessage.textContent = 'âœ… å¯¹è¯å®Œæˆï¼å¯ä»¥å¼€å§‹ä¸‹ä¸€è½®';
                        
                        // é‡ç½®è®¡æ—¶å™¨
                        timerDisplay.textContent = '00:00';
                    } else {
                        if (statusMessage) statusMessage.textContent = 'âŒ å¯¹è¯å¤±è´¥';
                        alert('å¯¹è¯å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(err => {
                    console.error('é”™è¯¯:', err);
                    if (statusMessage) statusMessage.textContent = 'âŒ å¯¹è¯å¤±è´¥';
                    alert('è¯·æ±‚å¤±è´¥: ' + err.message);
                });
        }

        // è¡¨å•æäº¤äº‹ä»¶ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
        document.getElementById('chatForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            processChat(formData);
        });
    </script>
</body>

</html>